<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RISC-V Specification Dashboard for BoD</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            overflow-x: hidden;
        }
        .on-track {
            background-color: #d4edda;
            color: #155724;
        }
        .exposed {
            background-color: #fff3cd;
            color: #856404;
        }
        .late {
            background-color: #f8d7da;
            color: #721c24;
        }
        .completed {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .table-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: auto;
        }
        table {
            margin-top: 10px;
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            table-layout: fixed;
            font-size: 13px;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            border: 1px solid #ddd;
            position: relative;
        }
        th, td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
            position: relative;
        }
        th {
            background-color: #f1f1f1;
            text-align: center;
            vertical-align: middle;
            white-space: normal;
        }
        .resizer {
            display: inline-block;
            width: 5px;
            height: 100%;
            position: absolute;
            right: 0;
            top: 0;
            cursor: col-resize;
            user-select: none;
        }
        .narrow-column {
            width: 120px;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        h2 {
            margin-bottom: 10px;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            text-align: center;
        }
        #header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            width: 100%;
            max-width: 1200px;
            align-self: center;
        }
        #save-button {
            font-size: 12px;  /* Smaller button size */
        }
        #last-updated,
        #countdown {
            font-size: 12px;
            color: #888;  /* Slightly darker color */
            text-align: center;
            margin-top: 5px;
        }
        .checkmark {
            color: green;
            font-size: 1.5em;
        }
        .current-phase {
            color: #1E90FF;  /* Less bright blue */
            font-size: 0.85em;  /* Smaller text size */
            white-space: nowrap;  /* Prevent wrapping */
        }
        .upcoming-phase {
            color: lightgray;
            font-size: 1.5em;
        }
        .timeline {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #ddd;
        }
        .timeline-point {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ddd;
            position: relative;
            z-index: 1;
        }
        .timeline-point.current {
            background: #007bff;
        }
        .timeline-point span {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.9.0/dist/html-to-image.min.js"></script>
    <script>
        function saveAsImage() {
            var node = document.querySelector('.table-container');
            var now = new Date();
            var formattedDate = now.getFullYear() + '-' +
                                ('0' + (now.getMonth() + 1)).slice(-2) + '-' +
                                ('0' + now.getDate()).slice(-2) + '_' +
                                ('0' + now.getHours()).slice(-2) + '-' +
                                ('0' + now.getMinutes()).slice(-2) + '-' +
                                ('0' + now.getSeconds()).slice(-2);
            var fileName = 'RISC-V_Specification_Dashboard_' + formattedDate + '.png';
            htmlToImage.toPng(node, {
                quality: 1,
                pixelRatio: 2 // Increase pixel ratio for higher quality
            })
            .then(function (dataUrl) {
                var link = document.createElement('a');
                link.href = dataUrl;
                link.download = fileName;
                link.click();
            })
            .catch(function (error) {
                console.error('Error generating image:', error);
            });
        }

        function getCurrentQuarter() {
            const month = new Date().getMonth() + 1;
            return Math.ceil(month / 3);
        }

        function getDaysLeftInQuarter() {
            const now = new Date();
            const currentQuarter = getCurrentQuarter();
            let endOfQuarter;
            switch (currentQuarter) {
                case 1:
                    endOfQuarter = new Date(now.getFullYear(), 2, 31); // March 31
                    break;
                case 2:
                    endOfQuarter = new Date(now.getFullYear(), 5, 30); // June 30
                    break;
                case 3:
                    endOfQuarter = new Date(now.getFullYear(), 8, 30); // September 30
                    break;
                case 4:
                    endOfQuarter = new Date(now.getFullYear(), 11, 31); // December 31
                    break;
            }
            const timeDiff = endOfQuarter - now;
            return Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // Convert milliseconds to days
        }

        function highlightCurrentQuarter() {
            const currentQuarter = getCurrentQuarter();
            const daysLeft = getDaysLeftInQuarter();
            const timelinePoints = document.querySelectorAll('.timeline-point');
            timelinePoints.forEach((point, index) => {
                if (index + 1 === currentQuarter) {
                    point.classList.add('current');
                    const span = point.querySelector('span');
                    span.textContent += ` (${daysLeft} days left)`;
                }
            });
        }

        function countCompletedPhases(row) {
            let count = 0;
            for (let i = 1; i <= 4; i++) {
                if (row.cells[i].classList.contains('checkmark')) {
                    count++;
                }
            }
            return count;
        }

        function parseQuarter(quarter) {
            const year = parseInt(quarter.slice(0, 2));
            const qtr = parseInt(quarter.slice(2));
            return { year, qtr };
        }

        function sortTable() {
            const table = document.querySelector('table tbody');
            const rows = Array.from(table.rows);

            rows.sort((a, b) => {
                const progressA = a.cells[8].textContent.toLowerCase();
                const progressB = b.cells[8].textContent.toLowerCase();
                const completedA = countCompletedPhases(a);
                const completedB = countCompletedPhases(b);
                const quarterA = parseQuarter(a.cells[7].textContent);
                const quarterB = parseQuarter(b.cells[7].textContent);

                if (progressA < progressB) return -1;
                if (progressA > progressB) return 1;
                if (completedA < completedB) return -1;
                if (completedA > completedB) return 1;
                if (quarterA.year < quarterB.year) return -1;
                if (quarterA.year > quarterB.year) return 1;
                if (quarterA.qtr < quarterB.qtr) return -1;
                if (quarterA.qtr > quarterB.qtr) return 1;
                return 0;
            });

            rows.forEach(row => table.appendChild(row));
        }

        window.onload = function() {
            startCountdown();
            highlightCurrentQuarter();
            sortTable();
        }

        // Refresh the page every 1 hour
        function startCountdown() {
            var countdownElement = document.getElementById('countdown');
            var timeLeft = 3600; // 1 hour in seconds

            var countdownTimer = setInterval(function() {
                var minutes = Math.floor(timeLeft / 60);
                var seconds = timeLeft % 60;
                //countdownElement.textContent = 'Page reloads in ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(countdownTimer);
                    location.reload();
                }
            }, 1000);
        }

        // Function to add resizers to table headers
        function addResizers() {
            const table = document.querySelector('table');
            const cols = table.querySelectorAll('th');
            cols.forEach((col) => {
                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                col.appendChild(resizer);
                resizer.addEventListener('mousedown', initResize);
            });
        }

        let startX, startWidth;

        function initResize(e) {
            startX = e.clientX;
            startWidth = parseInt(document.defaultView.getComputedStyle(e.target.parentElement).width, 10);
            document.documentElement.addEventListener('mousemove', doResize);
            document.documentElement.addEventListener('mouseup', stopResize);
        }

        function doResize(e) {
            e.target.parentElement.style.width = (startWidth + e.clientX - startX) + 'px';
        }

        function stopResize(e) {
            document.documentElement.removeEventListener('mousemove', doResize);
            document.documentElement.removeEventListener('mouseup', stopResize);
        }

        document.addEventListener('DOMContentLoaded', addResizers);
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Specification Dashboard</h2>
        <div class="timeline">
            <div class="timeline-point"><span>Q1</span></div>
            <div class="timeline-point"><span>Q2</span></div>
            <div class="timeline-point"><span>Q3</span></div>
            <div class="timeline-point"><span>Q4</span></div>
        </div>
        <div id="header">
            <button id="save-button" class="btn btn-primary" onclick="saveAsImage()">Save as Image</button>
        </div>
        <div class="table-container">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Specification</th>
                        <th>Planning<span class="phase-duration">30 days long on avg</span></th>
                        <th>Development<span class="phase-duration">60 days long on avg</span></th>
                        <th>Freeze<span class="phase-duration">90 days long on avg</span></th>
                        <th>Ratification-Ready<span class="phase-duration">60 days long on avg</span></th>
                        <th class="narrow-column">ISA or NON-ISA?</th>
                        <th class="narrow-column">Baseline Ratification Quarter</th>
                        <th class="narrow-column">Target Ratification Quarter</th>
                        <th class="narrow-column">Ratification Progress</th>
                    </tr>
                </thead>
                <tbody>
                    {% for index, row in data.iterrows() %}
                    {% set current_phase, next_phase = row['Status']|calculate_progress %}
                    <tr class="{{ (row['Ratification Progress']|default('')).replace(' ', '-').lower() }}">
                        <td><a href="{{ row['Jira URL'] }}" target="_blank">{{ row['Summary'] }}</a></td>
                        {% for phase in ['Planning', 'Development', 'Freeze', 'Ratification-Ready'] %}
                            {% if phase == current_phase %}
                                <td class="current-phase">In Progress</td>  <!-- In Progress text for current phase -->
                            {% elif ['Planning', 'Development', 'Freeze', 'Ratification-Ready'].index(phase) < ['Planning', 'Development', 'Freeze', 'Ratification-Ready'].index(current_phase) %}
                                <td class="checkmark">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="green" width="24px" height="24px"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.2l-4.2-4.2-1.4 1.4 5.6 5.6 12-12-1.4-1.4z"/></svg>
                                </td>  <!-- Green check mark for completed phases -->
                            {% else %}
                                <td class="upcoming-phase">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="lightgray" width="24px" height="24px"><circle cx="6" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="18" cy="12" r="2"/></svg>
                                </td>  <!-- Light gray three dots for future phases -->
                            {% endif %}
                        {% endfor %}
                        <td class="narrow-column">{{ row['ISA or NON-ISA?'] }}</td>
                        <td class="narrow-column">{{ row['Baseline Ratification Quarter'] }}</td>
                        <td class="narrow-column">{{ row['Target Ratification Quarter'] }}</td>
                        <td class="narrow-column">{{ row['Ratification Progress'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="last-updated">
            Last updated: {{ last_updated }}
        </div>
        <div id="countdown"></div>
    </div>
</body>
</html>
